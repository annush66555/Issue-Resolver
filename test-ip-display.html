<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Display Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }
        .connection-info {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .info-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            gap: 10px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover {
            background: #0056b3;
        }
        #status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>TwinDesk IP Display Test</h1>
        <div id="status">Initializing...</div>
        
        <div class="connection-info">
            <h4>ðŸ“‹ Connection Information:</h4>
            <div class="info-item">
                <strong>Your IP:</strong> 
                <span id="host-ip">Loading...</span>
                <button id="copy-ip-btn" class="btn">Copy</button>
            </div>
            <div class="info-item">
                <strong>Port:</strong> 
                <span id="host-port">3000</span>
            </div>
        </div>
        
        <button id="refresh-btn" class="btn">Refresh IP</button>
        <button id="test-copy-btn" class="btn">Test Copy Function</button>
    </div>

    <script>
        // Connection configuration for testing
        class ConnectionConfig {
            async getLocalIP() {
                try {
                    // Try to get local network IP using WebRTC
                    const localIP = await this.getLocalNetworkIP();
                    if (localIP && localIP !== 'localhost') {
                        return localIP;
                    }
                    
                    // Fallback to public IP if local IP detection fails
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    return data.ip;
                } catch (error) {
                    console.error('Failed to get IP address:', error);
                    return 'localhost';
                }
            }
            
            async getLocalNetworkIP() {
                return new Promise((resolve) => {
                    const timeout = setTimeout(() => {
                        resolve('localhost');
                    }, 3000);
                    
                    try {
                        const pc = new RTCPeerConnection({
                            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                        });
                        
                        pc.createDataChannel('');
                        
                        pc.onicecandidate = (ice) => {
                            if (!ice || !ice.candidate || !ice.candidate.candidate) return;
                            
                            const candidate = ice.candidate.candidate;
                            const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
                            
                            if (ipMatch) {
                                const ip = ipMatch[1];
                                if (ip !== '127.0.0.1' && !ip.startsWith('169.254') && this.isValidLocalIP(ip)) {
                                    clearTimeout(timeout);
                                    pc.close();
                                    resolve(ip);
                                }
                            }
                        };
                        
                        pc.createOffer().then(offer => pc.setLocalDescription(offer));
                        
                    } catch (error) {
                        console.error('WebRTC IP detection failed:', error);
                        clearTimeout(timeout);
                        resolve('localhost');
                    }
                });
            }
            
            isValidLocalIP(ip) {
                const parts = ip.split('.');
                if (parts.length !== 4) return false;
                
                const first = parseInt(parts[0]);
                const second = parseInt(parts[1]);
                
                return (
                    (first === 10) ||
                    (first === 172 && second >= 16 && second <= 31) ||
                    (first === 192 && second === 168)
                );
            }
        }

        // Initialize test
        const connConfig = new ConnectionConfig();
        const hostIpSpan = document.getElementById('host-ip');
        const copyIpBtn = document.getElementById('copy-ip-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const testCopyBtn = document.getElementById('test-copy-btn');
        const status = document.getElementById('status');

        async function updateIP() {
            try {
                status.textContent = 'Getting IP address...';
                hostIpSpan.textContent = 'Loading...';
                
                const ip = await connConfig.getLocalIP();
                hostIpSpan.textContent = ip;
                status.textContent = `IP address retrieved: ${ip}`;
                status.style.background = '#d4edda';
                status.style.color = '#155724';
            } catch (error) {
                console.error('Failed to get IP:', error);
                hostIpSpan.textContent = 'Error';
                status.textContent = `Error: ${error.message}`;
                status.style.background = '#f8d7da';
                status.style.color = '#721c24';
            }
        }

        // Copy function
        async function copyIP() {
            const text = hostIpSpan.textContent;
            try {
                await navigator.clipboard.writeText(text);
                const originalText = copyIpBtn.textContent;
                copyIpBtn.textContent = 'Copied!';
                copyIpBtn.style.background = '#28a745';
                setTimeout(() => {
                    copyIpBtn.textContent = originalText;
                    copyIpBtn.style.background = '#007bff';
                }, 2000);
                status.textContent = `Copied to clipboard: ${text}`;
                status.style.background = '#d4edda';
            } catch (err) {
                console.error('Copy failed:', err);
                status.textContent = `Copy failed: ${err.message}`;
                status.style.background = '#f8d7da';
            }
        }

        // Event listeners
        copyIpBtn.addEventListener('click', copyIP);
        refreshBtn.addEventListener('click', updateIP);
        testCopyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText('Test text').then(() => {
                status.textContent = 'Copy function is working!';
                status.style.background = '#d4edda';
            }).catch(err => {
                status.textContent = `Copy function failed: ${err.message}`;
                status.style.background = '#f8d7da';
            });
        });

        // Initialize on load
        updateIP();
    </script>
</body>
</html>
